

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Diseño procedimental &mdash; deployer 1 documentation</title>
  

  
  

  
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic|Roboto+Slab:400,700|Inconsolata:400,700&subset=latin,cyrillic' rel='stylesheet' type='text/css'>

  
  
    

  

  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="deployer 1 documentation" href="../../index.html"/>
        <link rel="up" title="Fase de diseño" href="intro.html"/>
        <link rel="next" title="Patrones de diseño destacados" href="patterns.html"/>
        <link rel="prev" title="Vista estática del sistema" href="static.html"/> 

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.6.2/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-nav-search">
        
          <a href="../../index.html" class="fa fa-home"> deployer</a>
        
        
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
        
          
          
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../installation.html">Installation</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../installation.html#certificates">Certificates</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../configuration.html">Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../manual/intro.html">Manual</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../manual/statusmonitor.html">Status Monitor</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../manual/deployer.html">Deployer</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../manual/logger.html">Logger</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../manual/receiver.html">Receiver</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../technical/intro.html">Technical details</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../technical/intro.html#security-concerns">Security concerns</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../technical/intro.html#authentication">Authentication</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../reference/intro.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../reference/deployer.html">The deployer module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/receiver.html">The receiver module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/statusmonitor.html">The statusmonitor module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/utils.html">The utils module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/bufferprocessor.html">The bufferprocessor module</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../reference/js/intro.html">JavaScript files</a></li>
</ul>
</li>
<li class="toctree-l1 current"><a class="reference internal" href="../intro.html">Ingeniería del software</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../analysis/intro.html">Fase de análisis</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="intro.html">Fase de diseño</a></li>
<li class="toctree-l2"><a class="reference internal" href="../project_mgmt/intro.html">Gestión del proyecto</a></li>
</ul>
</li>
</ul>

          
        
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../index.html">deployer</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../index.html">Docs</a> &raquo;</li>
      
          <li><a href="../intro.html">Ingeniería del software</a> &raquo;</li>
      
          <li><a href="intro.html">Fase de diseño</a> &raquo;</li>
      
    <li>Diseño procedimental</li>
      <li class="wy-breadcrumbs-aside">
        
          <a href="../../_sources/software_engineering/design/procedimental.txt" rel="nofollow"> View page source</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document">
            
  <div class="section" id="diseno-procedimental">
<h1>Diseño procedimental<a class="headerlink" href="#diseno-procedimental" title="Permalink to this headline">¶</a></h1>
<p>En este apartado se referencian los algoritmos implementados en el sistema que son considerados de mayor relevancia.</p>
<p>La aplicación utiliza las siguientes bibliotecas y <em>frameworks</em>:</p>
<ul class="simple">
<li><strong>Tornado</strong> como servidor web.</li>
<li><strong>Snorky</strong> para la gestión de los <strong>WebSocket</strong></li>
<li><strong>Jade</strong> como motor de renderizado de plantillas (mediante <strong>pyjade</strong>.</li>
<li><strong>jQuery</strong> como biblioteca para la gestión de peticiones asíncronas y gestión de los diferentes elementos con el <em>plugin</em> <strong>jQuery Cookie</strong>.</li>
<li><strong>Bootstrap</strong> para la gestión de los elementos visuales.</li>
<li><strong>MarcoPolo</strong> para la detección de los diferentes nodos.</li>
<li><strong>PAM</strong> para la gestión de usuarios mediante la interfaz <strong>python-pam</strong>.</li>
</ul>
<p>La autenticación en el cliente se realiza mediante la interfaz PAM disponible en Python. En caso de ser exitosa, el cliente recibe una cookie segura, firmada mediante HMAC y marcada temporalmente. Dicha cookie es enviada en todas las transmisiones WebSocket como token de autenticación (los nodos son capaces de descifrar el valor de la misma al conocer la clave criptográfica con la que se ha realizado el proceso de firmado).</p>
<p>Antes de realizarse el despliegue se crea el canal <strong>WebSocket</strong>. Todas las salidas se envían por el mismo canal. Los nodos mantienen una tabla clave-valor para identificar los <strong>WebSockets</strong> abiertos, siendo la clave el nombre de usuario en el sistema (mediante PAM dichos nombres son homogéneos en el sistema). Cada ejecución cuenta con un identificador aleatorio que el servidor comparte con el cliente.</p>
<div class="section" id="despliegue">
<h2>Despliegue<a class="headerlink" href="#despliegue" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">UploadAndDeployHandler</span><span class="p">(</span><span class="n">BaseHandler</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Listens for POST requests and performs the deployment asynchronously.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c">#The post is asynchronous due to the potencially long deploying time</span>
    <span class="nd">@asynchronous</span>
    <span class="nd">@engine</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">file1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="c">#Only one file at a time</span>

        <span class="n">original_fname</span> <span class="o">=</span> <span class="n">file1</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
       
        <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">__UPLOADS__</span><span class="p">,</span> <span class="n">original_fname</span><span class="p">),</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file1</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">])</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="c"># The nodes where to deploy are returned as a comma-separated string</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;nodes&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="kn">from</span> <span class="nn">concurrent</span> <span class="kn">import</span> <span class="n">futures</span>
        
        <span class="sd">&quot;&quot;&quot;The deployment process is performed asynchronously </span>
<span class="sd">        using a ThreadPool, which will handle the request asynchronously&quot;&quot;&quot;</span>

        <span class="n">futures_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">:</span>
            <span class="n">future</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">deploy</span><span class="p">(</span><span class="n">node</span><span class="o">=</span><span class="n">node</span><span class="p">,</span>
             <span class="n">request</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> 
             <span class="n">filename</span><span class="o">=</span><span class="n">original_fname</span><span class="p">,</span> 
             <span class="n">command</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> 
             <span class="n">user</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">current_user</span><span class="p">,</span> 
             <span class="n">folder</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;folder&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> 
             <span class="n">tomcat</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;tomcat&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">),</span> 
             <span class="n">overwrite</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;overwrite&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">))</span>
            
            <span class="n">futures_set</span><span class="o">.</span><span class="n">add</span><span class="p">((</span><span class="n">future</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>

        <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
       
        <span class="k">for</span> <span class="n">future</span><span class="p">,</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">futures_set</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">future</span><span class="o">.</span><span class="n">result</span><span class="p">()</span>
                
                <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">status_code</span> <span class="o">&gt;</span> <span class="mi">400</span><span class="p">:</span>
                    <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="n">response</span><span class="o">.</span><span class="n">reason</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">node</span><span class="p">,</span> <span class="s">&quot;Could not connect to the node&quot;</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">error</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s">&quot;Errors occurred &quot;</span> <span class="o">+</span> 
                <span class="s">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;Node:&quot;</span><span class="o">+</span><span class="n">node</span><span class="o">+</span><span class="s">&quot;.&quot;</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">reason</span> <span class="ow">in</span> <span class="n">error</span><span class="p">]))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s">&quot;file&quot;</span> <span class="o">+</span> <span class="n">original_fname</span> <span class="o">+</span> <span class="s">&quot; is uploaded and on deploy&quot;</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">deploy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">folder</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">idpolo</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">tomcat</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="s">&#39;false&#39;</span><span class="p">):</span>
        <span class="p">:</span><span class="n">param</span> <span class="nb">str</span> <span class="n">folder</span><span class="p">:</span> <span class="n">The</span> <span class="n">deployment</span> <span class="n">folder</span>
        
        <span class="p">:</span><span class="n">param</span> <span class="nb">str</span> <span class="n">idpolo</span><span class="p">:</span> <span class="n">The</span> <span class="nb">id</span> <span class="n">of</span> <span class="n">the</span> <span class="n">polo</span> <span class="n">service</span> <span class="n">to</span> <span class="n">publish</span>
        
        <span class="p">:</span><span class="n">param</span> <span class="nb">str</span> <span class="n">tomcat</span><span class="p">:</span> <span class="n">Specifies</span> <span class="n">whether</span> <span class="n">the</span> <span class="nb">file</span> <span class="n">should</span> <span class="n">be</span> <span class="n">deployed</span> <span class="k">as</span> <span class="n">a</span> <span class="n">tomcat</span> <span class="n">service</span>
        
        <span class="p">:</span><span class="n">param</span> <span class="nb">str</span> <span class="n">overwrite</span><span class="p">:</span> <span class="n">Specifies</span> <span class="k">if</span> <span class="n">the</span> <span class="nb">file</span> <span class="n">can</span> <span class="n">overwrite</span> <span class="n">existing</span> <span class="n">files</span>

        <span class="p">:</span><span class="n">returns</span><span class="p">:</span> <span class="p">:</span><span class="n">class</span><span class="p">:</span><span class="sb">`concurrent.future`</span> <span class="n">A</span> <span class="n">future</span> <span class="n">that</span> <span class="n">encapsulates</span> <span class="n">the</span> <span class="n">asynchronous</span> <span class="n">execution</span> 
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        def get_content_type(filename):</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">Guesses</span> <span class="n">the</span> <span class="n">MIME</span> <span class="nb">type</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">file</span> <span class="n">so</span> <span class="n">it</span> <span class="n">can</span> <span class="n">be</span> <span class="n">sent</span> <span class="k">with</span> <span class="n">the</span> <span class="n">POST</span> <span class="n">request</span>

            <span class="p">:</span><span class="n">param</span> <span class="nb">str</span> <span class="n">filename</span><span class="p">:</span> <span class="n">The</span> <span class="n">name</span> <span class="n">of</span> <span class="n">the</span> <span class="nb">file</span> <span class="n">to</span> <span class="n">process</span>
            <span class="s">&quot;&quot;&quot;</span>
<span class="s">            return mimetypes.guess_type(filename)[0] or &#39;application/octet-stream&#39;</span>

<span class="s">        url = &quot;https://&quot;+node+&quot;:&quot;+str(conf.RECEIVER_PORT)+&quot;/deploy/&quot;</span>
<span class="s">        </span>
<span class="s">        files = {&#39;file&#39;: (filename, </span>
<span class="s">                    open(os.path.join(__UPLOADS__, filename), &#39;rb&#39;), </span>
<span class="s">                    get_content_type(filename))</span>
<span class="s">                }</span>
<span class="s">        </span>
<span class="s">        commands = {&#39;command&#39;:command, </span>
<span class="s">                    &#39;user&#39;:user, </span>
<span class="s">                    &#39;folder&#39;: folder, </span>
<span class="s">                    &#39;idpolo&#39;: idpolo, </span>
</pre></div>
</td></tr></table></div>
<p>Secuencia de realización de un despliegue. Mediante el uso de <code class="docutils literal"><span class="pre">futures</span></code> se consigue que el código sea asíncrono y de esta forma se optimiza el rendimiento del sistema de forma significativa.</p>
</div>
<div class="section" id="recepcion-de-un-despliegue">
<h2>Recepción de un despliegue<a class="headerlink" href="#recepcion-de-un-despliegue" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">DeployHandler</span><span class="p">(</span><span class="n">RequestHandler</span><span class="p">):</span>
    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">post</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        POST handler received from ``deployer.py``. </span>
<span class="sd">        It handles the deployment of the file and the execution of the desired command.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">file1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="p">[</span><span class="s">&#39;file&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="n">command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;command&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">idpolo</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;idpolo&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="n">tomcat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;tomcat&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tomcat</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;folder&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">conf</span><span class="o">.</span><span class="n">TOMCAT_PATH</span>

        <span class="n">fname</span> <span class="o">=</span> <span class="n">file1</span><span class="p">[</span><span class="s">&#39;filename&#39;</span><span class="p">]</span>
        
        <span class="n">user</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;user&#39;</span><span class="p">,</span> <span class="s">&#39;&#39;</span><span class="p">)</span>
        
        <span class="n">user_pwd</span> <span class="o">=</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
        
        <span class="c">#Handling of relative paths</span>
        <span class="n">folder</span> <span class="o">=</span> <span class="n">folder</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&#39;~&#39;</span><span class="p">,</span> <span class="n">user_pwd</span><span class="o">.</span><span class="n">pw_dir</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">folder</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;/&#39;</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">user_pwd</span><span class="o">.</span><span class="n">pw_dir</span><span class="p">,</span> <span class="n">folder</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">folder</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">:</span>
            <span class="n">folder</span> <span class="o">=</span> <span class="n">user_pwd</span><span class="o">.</span><span class="n">pw_dir</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">folder</span><span class="p">):</span>
            <span class="n">makedirs</span><span class="p">(</span><span class="n">folder</span><span class="p">)</span>
            <span class="n">chown</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>


        <span class="n">final_directory</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        
        <span class="n">overwrite</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_argument</span><span class="p">(</span><span class="s">&#39;overwrite&#39;</span><span class="p">,</span> <span class="s">&#39;false&#39;</span><span class="p">)</span>
        
        <span class="n">overwrite</span> <span class="o">=</span> <span class="bp">False</span> <span class="k">if</span> <span class="n">overwrite</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s">&#39;false&#39;</span> <span class="k">else</span> <span class="bp">True</span><span class="p">;</span>


        <span class="n">thread_pool</span> <span class="o">=</span> <span class="n">futures</span><span class="o">.</span><span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">thread_pool</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">execute</span><span class="p">,</span> <span class="n">command</span><span class="o">=</span><span class="n">command</span><span class="p">,</span> <span class="n">file_desc</span><span class="o">=</span><span class="n">file1</span><span class="p">,</span> <span class="n">filename</span><span class="o">=</span><span class="n">final_directory</span><span class="p">,</span> <span class="n">directory</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="n">user_pwd</span><span class="p">,</span> <span class="n">tomcat</span><span class="o">=</span><span class="n">tomcat</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">finish</span><span class="p">(</span><span class="s">&#39;OK&#39;</span><span class="p">)</span>

    <span class="nd">@tornado.web.asynchronous</span>
    <span class="k">def</span> <span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">,</span> <span class="n">file_desc</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">tomcat</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="s">&quot;false&quot;</span><span class="p">):</span>
        
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">def</span> <span class="nf">demote</span><span class="p">(</span><span class="n">user_uid</span><span class="p">,</span> <span class="n">user_gid</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">user_gid</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">user_uid</span><span class="p">)</span>
            
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">filename</span><span class="p">)):</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="s">&#39;wb&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">output_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">file_desc</span><span class="p">[</span><span class="s">&#39;body&#39;</span><span class="p">])</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">tomcat</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">chown</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="s">&#39;tomcat7&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">pwd</span><span class="o">.</span><span class="n">getpwnam</span><span class="p">(</span><span class="s">&#39;tomcat7&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">)</span>
        <span class="n">output_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">ProcessReactor</span><span class="p">(</span><span class="n">user</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">io_loop</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">opensockets</span><span class="p">,</span> <span class="n">split</span><span class="p">(</span><span class="n">command</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">processes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pw_name</span><span class="p">,</span> <span class="bp">None</span><span class="p">)</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
                <span class="n">processes</span><span class="p">[</span><span class="n">user</span><span class="o">.</span><span class="n">pw_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</pre></div>
</td></tr></table></div>
</div>
<div class="section" id="ejecucion-de-un-comando">
<h2>Ejecución de un comando<a class="headerlink" href="#ejecucion-de-un-comando" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ProcessReactor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
	<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">ioloop</span><span class="p">,</span> <span class="n">ip</span><span class="p">,</span> <span class="n">opensockets</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Starts the command and sets the redirection of the desired buffers</span>
<span class="sd">		:param pwd: user The pwd structure with the information of the user which issued the command</span>
<span class="sd">		:param str directory: The directory to use as cwd</span>
<span class="sd">		:param list: args A list of supplementary arguments</span>
<span class="sd">		:param dict: kwargs A dictionary of keyword arguments</span>

<span class="sd">		The function redirects STDOUT and STDERR to a pipe, and then executes the command using Popen.</span>
<span class="sd">		The output pipe descriptor is made non-blocking and included in the instance of the IOLoop. </span>
<span class="sd">		&quot;&quot;&quot;</span>

		<span class="bp">self</span><span class="o">.</span><span class="n">user</span> <span class="o">=</span> <span class="n">user</span> <span class="c">#user which executes the command</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">command</span> <span class="o">=</span> <span class="s">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span> <span class="c"># The name of the command</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ip</span> <span class="o">=</span> <span class="n">ip</span> <span class="c"># The IP of the server</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">shell</span> <span class="o">=</span>  <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;shell&quot;</span><span class="p">,</span> <span class="bp">False</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span> <span class="o">=</span> <span class="n">ioloop</span>
		<span class="k">def</span> <span class="nf">randomString</span><span class="p">():</span>
			<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			Generates a random token</span>

<span class="sd">			:returns: A random string which acts as a token</span>
<span class="sd">			&quot;&quot;&quot;</span>
			<span class="k">return</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">SystemRandom</span><span class="p">()</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span> <span class="o">+</span> <span class="n">string</span><span class="o">.</span><span class="n">digits</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>

		<span class="c"># Generates a random token to identify the execution</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">identifier</span> <span class="o">=</span> <span class="s">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">string</span><span class="o">.</span><span class="n">ascii_uppercase</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>
		
		<span class="bp">self</span><span class="o">.</span><span class="n">opensockets</span>  <span class="o">=</span> <span class="n">opensockets</span>
		
		<span class="c">#The buffers are redirected</span>
		<span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;stdout&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
		<span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;stderr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>
		
		<span class="k">def</span> <span class="nf">demote</span><span class="p">(</span><span class="n">uid</span><span class="p">,</span> <span class="n">gid</span><span class="p">):</span>
			<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">			The UID and GID of the child process is changed to match those of the user</span>
<span class="sd">			who issued the command. Otherwise the operation would be executed as root.</span>
<span class="sd">			&quot;&quot;&quot;</span>
			<span class="n">os</span><span class="o">.</span><span class="n">setgid</span><span class="p">(</span><span class="n">gid</span><span class="p">)</span>
			<span class="n">os</span><span class="o">.</span><span class="n">setuid</span><span class="p">(</span><span class="n">uid</span><span class="p">)</span>

		<span class="n">kwargs</span><span class="p">[</span><span class="s">&#39;shell&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">False</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">preexec_fn</span><span class="o">=</span><span class="n">demote</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">pw_uid</span><span class="p">,</span> <span class="n">user</span><span class="o">.</span><span class="n">pw_gid</span><span class="p">),</span> <span class="c">#function executed before the call</span>
										<span class="n">cwd</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="c"># The current working directory is changed</span>
										<span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
		
		<span class="c">#The fileno of the stdout buffer is used to make it non-blocking</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
		<span class="n">fl</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFL</span><span class="p">)</span> <span class="c">#The file access mode is returned</span>
		<span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFL</span><span class="p">,</span> <span class="n">fl</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="c"># The flags of the file are modified, appending the non-blocking flag blogin</span>

		<span class="c">#The same for stderr</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">fd_err</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">fileno</span><span class="p">()</span>
		<span class="n">fl_err</span> <span class="o">=</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd_err</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_GETFL</span><span class="p">)</span>
		<span class="n">fcntl</span><span class="o">.</span><span class="n">fcntl</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fd_err</span><span class="p">,</span> <span class="n">fcntl</span><span class="o">.</span><span class="n">F_SETFL</span><span class="p">,</span> <span class="n">fl</span> <span class="o">|</span> <span class="n">os</span><span class="o">.</span><span class="n">O_NONBLOCK</span><span class="p">)</span>

		<span class="c">#Creation of the line buffer</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">line_buffer</span> <span class="o">=</span> <span class="n">LineBuffer</span><span class="p">()</span>

		<span class="c">#Two handlers are registered, each for one of the output buffers. can_read and can_read_stderr act as the callback for events related to both of them</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_read</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span>
		<span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">add_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">can_read_stderr</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">READ</span><span class="p">)</span>
	
	<span class="k">def</span> <span class="nf">kill</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">kill</span><span class="p">()</span>

	<span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
		<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;Sending terminate signal&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">call_later</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kill</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">can_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Processes the stdout event</span>
<span class="sd">		:param int fd: The file descriptor of the stdout buffer</span>
<span class="sd">		:param int events: The event flags (bitwise OR of the constants IOLoop.READ, IOLoop.WRITE, and IOLoop.ERROR)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
		

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="sd">&quot;&quot;&quot;If the length of the data is larger than zero, the information is sent to all</span>
<span class="sd">			the listening sockets&quot;&quot;&quot;</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">on_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;stdout&quot;</span><span class="p">)</span>

		<span class="k">else</span><span class="p">:</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;Lost connection to subprocess&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stop_output</span><span class="p">(</span><span class="s">&quot;stdout&quot;</span><span class="p">)</span>
	
	<span class="k">def</span> <span class="nf">can_read_stderr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fd</span><span class="p">,</span> <span class="n">events</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Processes the stderr event</span>
<span class="sd">		:param int fd: The file descriptor of the stderr buffer</span>
<span class="sd">		:param int events: The event flags (bitwise OR of the constants IOLoop.READ, IOLoop.WRITE, and IOLoop.ERROR)</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>

		<span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">on_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;stderr&quot;</span><span class="p">)</span>

		<span class="k">else</span><span class="p">:</span>
			<span class="k">print</span><span class="p">(</span><span class="s">&quot;Lost connection to subprocess&quot;</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">ioloop</span><span class="o">.</span><span class="n">remove_handler</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">stop_output</span><span class="p">(</span><span class="s">&quot;stderr&quot;</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">on_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Decodes the data and passes it to on_line</span>
<span class="sd">		:param bytes data: an array of bytes with the message</span>
<span class="sd">		:param str stream_name: The name of the stream</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">line_buffer</span><span class="o">.</span><span class="n">read_lines</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
			<span class="bp">self</span><span class="o">.</span><span class="n">on_line</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">),</span> <span class="n">stream_name</span><span class="p">)</span>

	<span class="k">def</span> <span class="nf">on_line</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sends the line to the open websocket</span>
<span class="sd">		:param str line: The message line</span>
<span class="sd">		:param str stream_name: The name of the stream</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opensockets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pw_name</span><span class="p">]:</span>
			<span class="n">ws</span><span class="o">.</span><span class="n">on_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pw_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">False</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="p">)</span>


	<span class="k">def</span> <span class="nf">stop_output</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stream_name</span><span class="o">=</span><span class="s">&quot;unknown&quot;</span><span class="p">):</span>
		<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">		Sends a special message to close the websocket connection</span>
<span class="sd">		&quot;&quot;&quot;</span>
		<span class="k">for</span> <span class="n">ws</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">opensockets</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pw_name</span><span class="p">]:</span>
			<span class="n">ws</span><span class="o">.</span><span class="n">on_line</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">pw_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">command</span><span class="p">,</span> <span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ip</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">identifier</span><span class="p">,</span> <span class="bp">True</span><span class="p">,</span> <span class="n">stream_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">shell</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>La ejecución de un comando es completamente asíncrona, dado que se vincula el descriptor de fichero de cada uno de los <em>streams</em> de salida del comando al bucle de eventos de Tornado, añadiendo manejadoras que recojan los diferentes eventos emitidos por el bucle relativos a dichos descriptores.</p>
</div>
<div class="section" id="recoleccion-de-datos">
<h2>Recolección de datos<a class="headerlink" href="#recoleccion-de-datos" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span class="k">def</span> <span class="nf">get_data</span><span class="p">():</span>
    <span class="n">response_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strftime</span><span class="p">(</span><span class="s">&quot;%a, </span><span class="si">%d</span><span class="s"> %b %Y %H:%M:%S&quot;</span><span class="p">,</span> <span class="n">localtime</span><span class="p">())</span>

    <span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;hostname&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;hostname&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;/sbin/ifconfig eth0| grep &#39;inet addr:&#39; | cut -d: -f2 | awk &#39;{ print $1}&#39;&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;ip&quot;</span><span class="p">])</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;ip&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot; /sbin/ifconfig eth0 | grep &#39;inet\ &#39; | cut -d: -f2 | awk &#39;{ print $2 }&#39;&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;kernel_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;uname -r&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
    
    <span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;memtotal&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;egrep --color &#39;MemTotal&#39; /proc/meminfo | egrep &#39;[0-9.]{4,}&#39; -o&quot;</span><span class="p">,</span>
                    <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>

    <span class="n">response_dict</span><span class="p">[</span><span class="s">&quot;memfree&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;egrep --color &#39;MemFree&#39; /proc/meminfo | egrep &#39;[0-9.]{4,}&#39; -o&quot;</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s">&#39;utf-8&#39;</span><span class="p">)</span>
</pre></div>
</td></tr></table></div>
<p>La recolección de datos se realiza mediante llamadas al sistema.</p>
</div>
</div>


          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="patterns.html" class="btn btn-neutral float-right" title="Patrones de diseño destacados">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="static.html" class="btn btn-neutral" title="Vista estática del sistema"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2015, Diego Martín.
    </p>
  </div>

  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
  
</footer>
        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>